<template>
  <div class="vuln-details">
    <el-card>
      <div slot="header">
        <span>漏洞详情</span>
        <el-button-group style="float: right">
          <el-button size="small" type="primary" @click="exportReport">导出报告</el-button>
          <el-button size="small" @click="refresh">刷新</el-button>
        </el-button-group>
      </div>

      <!-- 漏洞统计 -->
      <el-row :gutter="20" class="stats-row">
        <el-col :span="8" v-for="(stat, index) in vulnStats" :key="index">
          <el-card shadow="hover" :class="`stat-card ${stat.type}`">
            <div class="stat-value">{{ stat.value }}</div>
            <div class="stat-label">{{ stat.label }}</div>
          </el-card>
        </el-col>
      </el-row>

      <!-- 漏洞列表 -->
      <el-table
        :data="vulnerabilities"
        style="width: 100%"
        @row-click="handleVulnClick"
      >
        <el-table-column prop="url" label="URL" min-width="200" />
        <el-table-column prop="type" label="类型" width="120" />
        <el-table-column prop="severity" label="���重程度" width="100">
          <template #default="{ row }">
            <el-tag :type="getSeverityType(row.severity)">{{ row.severity }}</el-tag>
          </template>
        </el-table-column>
        <el-table-column prop="found_time" label="发现时间" width="160">
          <template #default="{ row }">
            {{ formatDateTime(row.found_time) }}
          </template>
        </el-table-column>
        <el-table-column prop="status" label="状态" width="100">
          <template #default="{ row }">
            <el-tag :type="getStatusType(row.status)">{{ row.status }}</el-tag>
          </template>
        </el-table-column>
      </el-table>

      <!-- 漏洞详情对话框 -->
      <el-dialog
        title="漏洞详情"
        :visible.sync="dialogVisible"
        width="70%"
      >
        <template v-if="selectedVuln">
          <el-descriptions border>
            <el-descriptions-item label="URL" :span="3">{{ selectedVuln.url }}</el-descriptions-item>
            <el-descriptions-item label="类型">{{ selectedVuln.type }}</el-descriptions-item>
            <el-descriptions-item label="严重程度">
              <el-tag :type="getSeverityType(selectedVuln.severity)">{{ selectedVuln.severity }}</el-tag>
            </el-descriptions-item>
            <el-descriptions-item label="状态">
              <el-tag :type="getStatusType(selectedVuln.status)">{{ selectedVuln.status }}</el-tag>
            </el-descriptions-item>
            <el-descriptions-item label="描述" :span="3">{{ selectedVuln.description }}</el-descriptions-item>
            <el-descriptions-item label="影响" :span="3">{{ selectedVuln.impact }}</el-descriptions-item>
            <el-descriptions-item label="解决方案" :span="3">{{ selectedVuln.solution }}</el-descriptions-item>
          </el-descriptions>

          <!-- 证据信息 -->
          <div class="evidence-section" v-if="selectedVuln.evidence">
            <h3>漏洞证据</h3>
            <el-tabs type="border-card">
              <el-tab-pane label="请求信息">
                <pre>{{ selectedVuln.evidence.request }}</pre>
              </el-tab-pane>
              <el-tab-pane label="响应信息">
                <pre>{{ selectedVuln.evidence.response }}</pre>
              </el-tab-pane>
            </el-tabs>
          </div>

          <!-- 操作按钮 -->
          <div class="dialog-footer">
            <el-button @click="handleVerify">验证漏洞</el-button>
            <el-button type="primary" @click="handleFix">修复建议</el-button>
          </div>
        </template>
      </el-dialog>
    </el-card>
  </div>
</template>

<script lang="ts">
import { ref, computed, onMounted } from 'vue'
import { getVulnerabilities, exportReport } from '@/api/dirScan'
import { formatDateTime } from '@/utils/format'

export default {
  name: 'VulnerabilityDetails',
  props: {
    taskId: {
      type: Number,
      required: true
    }
  },
  setup(props) {
    const vulnerabilities = ref([])
    const dialogVisible = ref(false)
    const selectedVuln = ref(null)

    // 漏洞统计
    const vulnStats = computed(() => {
      const stats = {
        high: 0,
        medium: 0,
        low: 0
      }
      vulnerabilities.value.forEach(vuln => {
        stats[vuln.severity]++
      })
      return [
        { label: '高危漏洞', value: stats.high, type: 'high' },
        { label: '中危漏洞', value: stats.medium, type: 'medium' },
        { label: '低危漏洞', value: stats.low, type: 'low' }
      ]
    })

    // 获取严重程度样式
    const getSeverityType = (severity: string): string => {
      const types: { [key: string]: string } = {
        high: 'danger',
        medium: 'warning',
        low: 'info'
      }
      return types[severity] || 'info'
    }

    // 获取状态样式
    const getStatusType = (status: string): string => {
      const types: { [key: string]: string } = {
        confirmed: 'danger',
        pending: 'warning',
        fixed: 'success'
      }
      return types[status] || 'info'
    }

    // 处理漏洞点击
    const handleVulnClick = (row: any) => {
      selectedVuln.value = row
      dialogVisible.value = true
    }

    // 验证漏洞
    const handleVerify = async () => {
      // TODO: 实现漏洞验证逻辑
    }

    // 修复建议
    const handleFix = () => {
      // TODO: 实现修复建议展示
    }

    // 导出报告
    const handleExport = async () => {
      try {
        await exportReport(props.taskId, 'pdf')
      } catch (error) {
        console.error('Failed to export report:', error)
      }
    }

    // 刷新数据
    const refresh = async () => {
      try {
        const data = await getVulnerabilities(props.taskId)
        vulnerabilities.value = data
      } catch (error) {
        console.error('Failed to fetch vulnerabilities:', error)
      }
    }

    onMounted(() => {
      refresh()
    })

    return {
      vulnerabilities,
      vulnStats,
      dialogVisible,
      selectedVuln,
      getSeverityType,
      getStatusType,
      handleVulnClick,
      handleVerify,
      handleFix,
      handleExport,
      refresh,
      formatDateTime
    }
  }
}
</script>

<style scoped>
.vuln-details {
  padding: 20px;
}

.stats-row {
  margin-bottom: 20px;
}

.stat-card {
  text-align: center;
  padding: 20px;
}

.stat-value {
  font-size: 24px;
  font-weight: bold;
}

.stat-label {
  margin-top: 10px;
  color: #666;
}

.stat-card.high .stat-value {
  color: #F56C6C;
}

.stat-card.medium .stat-value {
  color: #E6A23C;
}

.stat-card.low .stat-value {
  color: #67C23A;
}

.evidence-section {
  margin-top: 20px;
}

.evidence-section pre {
  background: #f5f7fa;
  padding: 10px;
  border-radius: 4px;
  overflow-x: auto;
}

.dialog-footer {
  margin-top: 20px;
  text-align: right;
}
</style> 